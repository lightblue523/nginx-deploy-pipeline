stages:
  - deploy

.default_deploy_script: &deploy_script
  image: rdidc-k8s-harbor.axiom-gaming.tech/devops/k8s:stable
  tags:
    - ags-rel
  variables:
    ECS_SSH_USER: nginxdeploy                         # sshç”¨æˆ¶å
    DEPLOY_CONF_BASE: /opt/nginx/config/conf          # ç›®æ¨™æ©Ÿ nginx conf ç›®éŒ„ä½ç½®
    DEPLOY_CONFD_BASE: /opt/nginx/config/conf.d       # ç›®æ¨™æ©Ÿ nginx conf.d ç›®éŒ„ä½ç½®
    DEPLOY_SSL_BASE: /opt/nginx/config/ssl            # ç›®æ¨™æ©Ÿ nginx ssl ç›®éŒ„ä½ç½®
    SCRIPT_BASE: /opt/nginx                           # nginxèµ·åœè…³æœ¬ä½ç½®
    WAIT_SECONDS: 10
    CONTAINER_NAME: nginx                             # nginxå®¹å™¨åç¨±
    BACKUP_SUFFIX: .bak                               # å‚™ä»½å¾Œç¶´
  before_script:
    - mkdir -p ~/.ssh
    - echo "$ECS_SSH_KEY" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H "$ECS_SSH_HOST" >> ~/.ssh/known_hosts || echo "âš ï¸ ssh-keyscan å¤±æ•—"
    - echo "ğŸ§ª SSH é€£ç·šæ¸¬è©¦..."
    - ssh -o BatchMode=yes -o ConnectTimeout=5 $ECS_SSH_USER@$ECS_SSH_HOST 'echo âœ… SSH é€£ç·šæˆåŠŸ' || {
        echo "âŒ SSH ç„¡æ³•é€£ç·šï¼Œè«‹æª¢æŸ¥ ECS çš„å…¬ç¶² IPã€é˜²ç«ç‰†æˆ–é‡‘é‘°æ˜¯å¦æ­£ç¢º";
        exit 1;
      }
    - git config --global --add safe.directory "$CI_PROJECT_DIR"

.deploy_job_script: &deploy_job_script
  script:
    - echo "ğŸ“¦ æª¢æŸ¥é…ç½®æª”æ¡ˆ..."
    - |
      if [ "$DEPLOY_MODE" = "auto" ]; then
        if [ "$CI_COMMIT_BEFORE_SHA" = "0000000000000000000000000000000000000000" ]; then
          echo "âš ï¸ before_sha ç‚º 0ï¼Œæ”¹ç”¨ HEAD~1"
          git fetch origin main
          CHANGED_CONF_FILES=$(git diff --name-only origin/main~1 $CI_COMMIT_SHA | grep 'nginx.conf$' || true)
          CHANGED_CONFD_FILES=$(git diff --name-only origin/main~1 $CI_COMMIT_SHA | grep '\.conf$' | grep -v nginx.conf || true)
          CHANGED_SSL_FILES=$(git diff --name-only origin/main~1 $CI_COMMIT_SHA | grep '\.pem$' || true)
          CHANGED_SSL_DIRS=$(git diff --name-only origin/main~1 $CI_COMMIT_SHA | grep '\.pem$' | xargs -n1 dirname | uniq || true)
        else
          CHANGED_CONF_FILES=$(git diff --name-only $CI_COMMIT_BEFORE_SHA $CI_COMMIT_SHA | grep 'nginx.conf$' || true)
          CHANGED_CONFD_FILES=$(git diff --name-only $CI_COMMIT_BEFORE_SHA $CI_COMMIT_SHA | grep '\.conf$' | grep -v nginx.conf || true)
          CHANGED_SSL_FILES=$(git diff --name-only $CI_COMMIT_BEFORE_SHA $CI_COMMIT_SHA | grep '\.pem$' || true)
          CHANGED_SSL_DIRS=$(git diff --name-only $CI_COMMIT_BEFORE_SHA $CI_COMMIT_SHA | grep '\.pem$' | xargs -n1 dirname | uniq || true)
        fi
      else
        # ğŸŸ¢ manual æ¨¡å¼ç›´æ¥æŸ¥æ‰¾å·¥ä½œå€ä¸‹æ‰€æœ‰ .conf
        CHANGED_CONF_FILES=$(find conf -type f -name 'nginx.conf' || true)
        CHANGED_CONFD_FILES=$(find conf.d -type f -name '*.conf' | grep -v nginx.conf || true)
        CHANGED_SSL_FILES=$(find ssl -type f -name '*.pem' || true)
        CHANGED_SSL_DIRS=$(find ssl -type f -name '*.pem' | xargs -n1 dirname | uniq || true)
      fi

    - |
      # åˆå§‹åŒ– SKIP_COUNT
      SKIP_COUNT=0

      # --- conf.d ---
      echo -e "\033[1;37m------------------------------------------\033[0m"
      echo -e "\033[1;37m--- é–‹å§‹è™•ç† conf.dï¼Œä»¥ä¸‹åˆ—å‡ºæ­¤æ¬¡ä¿®æ”¹çš„æª”æ¡ˆ ---\033[0m"
      echo -e "\033[1;37m------------------------------------------\033[0m"
      echo "$CHANGED_CONFD_FILES"
      if [ -n "$CHANGED_CONFD_FILES" ]; then
        for FILE in $CHANGED_CONFD_FILES; do
          PROJECT=$(echo $FILE | cut -d'/' -f2)
          ENV=$(echo $FILE | cut -d'/' -f3)
          CONF_NAME=$(basename $FILE)
          SERVICE_NAME=${CONF_NAME%.conf}
          REMOTE_DIR=$DEPLOY_CONFD_BASE/$PROJECT/$ENV

          echo "ğŸšš æ­£åœ¨è™•ç† conf.d é…ç½®æª” $CONF_NAME"
          echo "ğŸ“‚ ä¸Šå‚³åˆ° $REMOTE_DIR/"
          ssh $ECS_SSH_USER@$ECS_SSH_HOST "
            mkdir -p $REMOTE_DIR &&
            cp $REMOTE_DIR/$CONF_NAME $REMOTE_DIR/$CONF_NAME$BACKUP_SUFFIX 2>/dev/null || true
          "
          scp $FILE $ECS_SSH_USER@$ECS_SSH_HOST:$REMOTE_DIR/$CONF_NAME

          echo "ğŸ” $CONF_NAME é…ç½®æª”å·²è¦†è“‹ï¼Œé©—è­‰é…ç½®æª”èªæ³•æ­£ç¢ºæ€§..."
          confdVerifyResult=$(ssh $ECS_SSH_USER@$ECS_SSH_HOST "
            sudo docker exec $CONTAINER_NAME nginx -t
            echo \$?
          ")
          if [ $confdVerifyResult -ne 0 ]; then
            echo "âŒ $CONF_NAME é…ç½®æª”é©—è­‰å¤±æ•—ï¼Œé–‹å§‹å›æ»¾..."
            ssh $ECS_SSH_USER@$ECS_SSH_HOST "
              mv -f $REMOTE_DIR/$CONF_NAME$BACKUP_SUFFIX $REMOTE_DIR/$CONF_NAME
            "
            echo -e "\033[1;31mâŒâŒâŒ $CONF_NAME å›æ»¾å®Œç•¢ï¼Œè«‹æª¢å¯Ÿçµ„æ…‹ä¸¦æ–¼ä¿®æ”¹å¾Œå†æ¬¡éƒ¨ç½²ã€‚ âŒâŒâŒ\033[0m"
          else
            echo "âœ”ï¸ $CONF_NAME é©—è­‰æˆåŠŸ"
            ssh $ECS_SSH_USER@$ECS_SSH_HOST "rm -f $REMOTE_DIR/$CONF_NAME$BACKUP_SUFFIX"
          fi
        done
      else
        echo "âœ… æ²’æœ‰ conf.d é…ç½®æª”è®Šæ›´ï¼Œè·³éæ­¤éƒ¨åˆ†"
        SKIP_COUNT=$((SKIP_COUNT+1))
      fi

      # --- conf/nginx.conf ---
      echo -e "\033[1;37m-------------------------------\033[0m"
      echo -e "\033[1;37m--- é–‹å§‹è™•ç† conf/nginx.conf ---\033[0m"
      echo -e "\033[1;37m-------------------------------\033[0m"
      if [ -n "$CHANGED_CONF_FILES" ]; then
        for FILE in $CHANGED_CONF_FILES; do
          CONF_NAME=$(basename $FILE)
          REMOTE_DIR=$DEPLOY_CONF_BASE

          echo "ğŸšš æ­£åœ¨è™•ç† $CONF_NAME é…ç½®æª”"
          echo "ğŸ“‚ ä¸Šå‚³åˆ° $REMOTE_DIR/"
          ssh $ECS_SSH_USER@$ECS_SSH_HOST "
            mkdir -p $REMOTE_DIR &&
            cp $REMOTE_DIR/$CONF_NAME $REMOTE_DIR/$CONF_NAME$BACKUP_SUFFIX 2>/dev/null || true
          "
          scp $FILE $ECS_SSH_USER@$ECS_SSH_HOST:$REMOTE_DIR/$CONF_NAME

          echo "ğŸ” conf/nginx.conf é…ç½®æª”å·²è¦†è“‹ï¼Œé©—è­‰é…ç½®æª”èªæ³•æ­£ç¢ºæ€§..."
          confVerifyResult=$(ssh $ECS_SSH_USER@$ECS_SSH_HOST "
            sudo docker exec $CONTAINER_NAME nginx -t
            echo \$?
          ")
          if [ $confVerifyResult -ne 0 ]; then
            echo "âŒ conf/nginx.conf é…ç½®æª”é©—è­‰å¤±æ•—ï¼Œé–‹å§‹å›æ»¾..."
            ssh $ECS_SSH_USER@$ECS_SSH_HOST "
              mv -f $REMOTE_DIR/$CONF_NAME$BACKUP_SUFFIX $REMOTE_DIR/$CONF_NAME
            "
            echo -e "\033[1;31mâŒâŒâŒ $CONF_NAME å›æ»¾å®Œç•¢ï¼Œè«‹æª¢å¯Ÿçµ„æ…‹ä¸¦æ–¼ä¿®æ”¹å¾Œå†æ¬¡éƒ¨ç½²ã€‚ âŒâŒâŒ\033[0m"
          else
            echo "âœ”ï¸ $CONF_NAME é©—è­‰æˆåŠŸ"
            ssh $ECS_SSH_USER@$ECS_SSH_HOST "rm -f $REMOTE_DIR/$CONF_NAME$BACKUP_SUFFIX"
          fi
        done
      else
        echo "âœ… æ²’æœ‰ conf/nginx.conf é…ç½®æª”è®Šæ›´ï¼Œè·³éæ­¤éƒ¨åˆ†"
        SKIP_COUNT=$((SKIP_COUNT+1))
      fi

      # --- ssl (.pem) ---
      echo -e "\033[1;37m-------------------------------------------\033[0m"
      echo -e "\033[1;37m--- é–‹å§‹è™•ç† ssl æ†‘è­‰ï¼Œä»¥ä¸‹åˆ—å‡ºæ­¤æ¬¡æ›´å‹•çš„æ†‘è­‰ ---\033[0m"
      echo -e "\033[1;37m-------------------------------------------\033[0m"
      echo "$CHANGED_SSL_FILES"
      if [ -n "$CHANGED_SSL_DIRS" ]; then
        for DIR in $CHANGED_SSL_DIRS; do
          DIR_NAME=$(echo $DIR | cut -d'/' -f2)
          REMOTE_DIR=$DEPLOY_SSL_BASE/$DIR_NAME

          echo "ğŸšš æ­£åœ¨æ›´æ› sslæ†‘è­‰ç›®éŒ„ $DIR_NAME"
          echo "ğŸ“‚ ä¸Šå‚³åˆ° $REMOTE_DIR/"
          ssh $ECS_SSH_USER@$ECS_SSH_HOST "
            mkdir -p $REMOTE_DIR &&
            rm -rf /tmp/ssl-backup-tmp/$DIR_NAME$BACKUP_SUFFIX &&
            cp -r $REMOTE_DIR /tmp/ssl-backup-tmp/$DIR_NAME$BACKUP_SUFFIX 2>/dev/null || true
          "
          scp -r $DIR $ECS_SSH_USER@$ECS_SSH_HOST:$DEPLOY_SSL_BASE

          echo "ğŸ” $DIR_NAME æ†‘è­‰å·²ä¸Šå‚³ï¼Œé€²è¡Œå…¬ç§é‘°æ¯”å°é©—è­‰..."
          sslVerifyResult=$(ssh $ECS_SSH_USER@$ECS_SSH_HOST "
            openssl x509 -in $REMOTE_DIR/fullchain.pem -pubkey -noout > /tmp/ssl-backup-tmp/cert_pub.pem &&
            openssl pkey -in $REMOTE_DIR/privkey.pem -pubout > /tmp/ssl-backup-tmp/key_pub.pem &&
            diff /tmp/ssl-backup-tmp/cert_pub.pem /tmp/ssl-backup-tmp/key_pub.pem >/dev/null 2>&1
            echo \$?
          ")
          if [ $sslVerifyResult -ne 0 ]; then
            echo "âŒ å…¬ç§é‘°æ¯”å°é©—è­‰å¤±æ•—ï¼Œé–‹å§‹å›æ»¾..."
            ssh $ECS_SSH_USER@$ECS_SSH_HOST "
              mv -f /tmp/ssl-backup-tmp/$DIR_NAME$BACKUP_SUFFIX $REMOTE_DIR &&
              rm -f /tmp/ssl-backup-tmp/cert_pub.pem && rm -f /tmp/ssl-backup-tmp/key_pub.pem
            "
            echo -e "\033[1;31mâŒâŒâŒ $DIR_NAME å›æ»¾å®Œç•¢ï¼Œè«‹æª¢å¯Ÿæ†‘è­‰ä¸¦æ–¼ä¿®æ”¹å¾Œå†æ¬¡éƒ¨ç½²ã€‚ âŒâŒâŒ\033[0m"
          else
            echo "âœ”ï¸ $DIR_NAME é©—è­‰æˆåŠŸ"
            ssh $ECS_SSH_USER@$ECS_SSH_HOST "
              rm -rf /tmp/ssl-backup-tmp/$DIR_NAME$BACKUP_SUFFIX && rm -f /tmp/ssl-backup-tmp/cert_pub.pem && rm -f /tmp/ssl-backup-tmp/key_pub.pem
            "
          fi
        done
      else
        echo "âœ… æ²’æœ‰ sslæ†‘è­‰ è®Šæ›´ï¼Œè·³ééƒ¨ç½²æ­¤éƒ¨åˆ†ã€‚"
        SKIP_COUNT=$((SKIP_COUNT+1))
      fi

      # --- æª¢æŸ¥è‹¥ç„¡ä»»ä½•ä¿®æ”¹ï¼Œå‰‡çµæŸç¨‹åºï¼Œè·³éå¾ŒçºŒé‡å•Ÿã€‚ ---
      if [ "$SKIP_COUNT" -eq 3 ]; then
        echo "âœ… conf.dã€confã€ssl éƒ½æ²’æœ‰è®Šæ›´ï¼Œè·³éå¾ŒçºŒé‡å•Ÿï¼Œç¨‹åºçµæŸã€‚"
        exit 0
      fi

      # --- nginx é‡å•Ÿ ---
      echo "âœ… é…ç½®é©—è­‰å®Œæˆï¼Œé‡å•Ÿ nginx..."
      ssh $ECS_SSH_USER@$ECS_SSH_HOST "
        cd $SCRIPT_BASE &&
        sudo ./stop.sh &&
        echo 'â³ ç­‰å¾… $WAIT_SECONDS ç§’...' &&
        sleep $WAIT_SECONDS &&
        sudo ./start.sh
      "
      echo "âœ… Nginx é‡å•Ÿå®Œæˆ"

deploy_auto:
  stage: deploy
  extends:
    - .default_deploy_script
    - .deploy_job_script
  variables:
    DEPLOY_MODE: "auto"
  only:
    changes:
      - conf/**/*
      - conf.d/**/*
      - ssl/**/*

deploy_manual:
  stage: deploy
  extends:
    - .default_deploy_script
    - .deploy_job_script
  variables:
    DEPLOY_MODE: "manual"
  when: manual
  allow_failure: false
